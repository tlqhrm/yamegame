<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>main.html</title>

    <!-- <link rel="stylesheet" href="https://www.retrogames.cc/css/app.css?202005">
    <script src="https://www.retrogames.cc/bower_components/jquery/dist/jquery.js"></script>
    <script src="https://www.retrogames.cc/bower_components/foundation-sites/dist/foundation.js"></script>
    <script src="https://www.retrogames.cc/js/jquery.toast.min.js?v=1" type="text/javascript"></script>
    <script src="https://www.retrogames.cc/js/jquery.loading.min.js" type="text/javascript"></script> -->
    <script src="https://raw.githack.com/tlqhrm/nds/main/jquery.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://raw.githack.com/tlqhrm/nds/main/app.css">
    <script src="https://raw.githack.com/tlqhrm/nds/main/foundation.js" type="text/javascript"></script>
    <script src="https://raw.githack.com/tlqhrm/nds/main/jquery.loading.min.js" type="text/javascript"></script>
    <script src="https://raw.githack.com/tlqhrm/nds/main/jquery.toast.min.js" type="text/javascript"></script>
    <!-- <script src="https://www.retrogames.cc/js/es6-promise.min.js"></script>
    <script>if (typeof Promise == 'undefined') window.Promise = ES6Promise.Promise;</script> -->

    <style>
        [type=text], [type=password], [type=date], [type=datetime], [type=datetime-local], [type=month], [type=week], [type=email], [type=number], [type=search], [type=tel], [type=time], [type=url], [type=color], textarea{margin-bottom:0}
        
        .reveal#loadStates .title {font-size:18px;}
        div#loadStates ul{color: #fff;background: transparent;font-size: 14px;border: none;padding: 10px;}
        div#loadStates ul li{display:inline-block}
        div#loadStates ul li a{color: #fff;padding: 5px 10px;background:#333}
        div#loadStates ul li a.active{background: #151515;}
        div#loadStates .tab-contents{height: calc(100% - 90px);overflow:auto}
        div#loadStates .tab-contents .content{display:none;height: 100%;margin:0}
        div#loadStates .tab-contents .content.active{display:block}
        .drag-drop-inside{height: 100%;margin: 0;border: 2px dashed;display: flex;align-items: center;text-align: center;padding:30px 0;justify-content: center;flex-direction: column;}
        .drag-drop-inside p{margin: 1px;}
        .is-dragover {background-color: rgba(128,128,128,0.2);}
        input[type=radio] + .customLabel:before{content: " ";border: none;}
        input[type=radio]:checked + .customLabel:before{content:"\f00c"}
        thead th, thead td, tfoot th, tfoot td{padding:0}
    
        .save-state-process, .save-state-process .circle, .save-state-process .percent{position: absolute;width: 50px;height: 50px;border-radius: 50%;}
        .save-state-process{bottom:60px;left:10px;background-color: transparent;}
        .save-state-process .circle{box-sizing: border-box;border:5px solid transparent;clip:rect(0,50px,50px,25px);}
        .save-state-process .clip-auto{clip:rect(auto, auto, auto, auto);}
        .save-state-process .percent{box-sizing: border-box;top:-5px;left:-5px;}
        .save-state-process .left{transition:transform ease;border:5px solid #ff5b5b;clip: rect(0,25px,50px,0);}
        .save-state-process .right{border:5px solid #ff5b5b;clip: rect(0,50px,50px,25px);}
        .save-state-process .wth0{width:0;}
        .save-state-process .num{
            color:#fff;
            position: absolute;
            box-sizing: border-box;width: 40px;height: 40px;line-height: 40px;text-align: center;font-size: 12px;left: 5px;top: 5px;border-radius: 50%;background:transparent;z-index: 1;}
    
        .ejs--7a5f920ceffb2913f6dbda780573cf *{-moz-user-select: none;-webkit-user-select: none;-ms-user-select: none;-khtml-user-select: none;user-select: none;}
        .ejs--6e7015634623fd6a82e6a7d3488c84{touch-action: none;-webkit-touch-callout: none;}
    </style>
</head>
<body style="background-color: #000;width:100%;height:100%">
    <script>
        // if (window.top == window) {
        //     document.write('Loading...');
        //     document.location.href = 'https://www.retrogames.cc/gameboyadvance-games/2-in-1-dragon-ball-z-buu-s-fury-dragon-ball-gt-transformation-u-independent.html';
        // }
    </script>
    <div style="width:auto;height:100%;max-width:100%;margin:0 auto">
    <div id="game">
    <div style="text-align:center">
    
    <p style="margin-top: calc(50vh - 20px);font-size:30px">Loading...</p>
    </div>
    </div>
    <div class="save-state-process" style="position: absolute !important;;display: none;">
    <div class="circle">
    <div class="percent left"></div>
    <div class="percent right wth0"></div>
    </div>
    <div class="num"><span>0</span>%</div>
    </div>
    <div class="small reveal" id="loginModal" data-reveal>
    <h1 class="title" style="font-size:24px">로그인</h1>
    <div class="content">
    <div class="login-form" style="display: block;border:none;width: 100%;position: static">
    <form method="post" action="">
    <div class="input-group">
    <span class="input-group-label"><i class="fa fa-user"></i></span>
    <input class="input-group-field" name="_username" type="text" placeholder="Enter username">
    </div>
    <div class="input-group">
    <span class="input-group-label"><i class="fa fa-lock"></i></span>
    <input class="input-group-field" name="_password" type="password" placeholder="Enter password">
    </div>
    <div class="checkbox">
    <input id="check1" type="checkbox" name="_remember_me" value="1">
    <label class="customLabel" for="check1">Remember me</label>
    </div>
    <input type="submit" name="submit" value="Login Now">
    </form>
    <p class="text-center">New here? <a target="_blank" class="newaccount" href="/register.html">Create a new Account</a></p>
    <h5 class="text-center">OR</h5>
    <div class="social-login" data-equalizer-watch="">
    <div class="social-login-btn facebook" style="max-width: 250px;margin: 0 auto;">
    <a href="#" class="fb-login"><i class="fa fa-facebook"></i>login via facebook</a>
    </div>
    </div>
    </div>
    </div>
    <button class="close-button" data-close aria-label="Close modal" type="button">
    <span style="color: #000;font-size: 20px" aria-hidden="true">&times;</span>
    </button>
    </div>
    <div class="large reveal fill-height" id="loadStates" data-reveal>
    <h1 class="title">세이브 불러오기</h1>
    <ul class="tabs">
    <li><a href="#" class="active">Upload</a></li>
    <li><a href="#">From Server</a></li>
    </ul>
    <div class="tab-contents">
    <div class="content active">
    <div class="drag-drop-inside">
    <p>Drop files here</p>
    <p>or</p>
    <p><input id="file-browse-button" type="button" value="Select Files" class="button tiny" style="position: relative; z-index: 1;"></p>
    </div>
    </div>
    <div class="content">
    </div>
    </div>
    <button class="close-button" data-close aria-label="Close modal" type="button">
    <span style="color: #fff;font-size: 20px" aria-hidden="true">&times;</span>
    </button>
    </div>
    <div class="tiny reveal" id="dialogModal" data-reveal data-overlay="false">
    <h1 class="title" style="font-size:18px"></h1>
    <div class="content"></div>
    <button class="close-button" data-close aria-label="Close modal" type="button">
    <span style="color: #fff;font-size: 20px" aria-hidden="true">&times;</span>
    </button>
     <div class="actions text-center">
    <a class="button primary submit tiny" data-close tabindex="0">확인</a>
    <a class="button tiny cancel" data-close tabindex="0">취소</a>
    </div>
    </div>
    </div>
    

    <h1>main page</h1>

    <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. 
        Atque, ullam quos! Iste quae, molestiae vitae tenetur, 
        in a aperiam voluptatibus dicta qui doloribus libero suscipit optio delectus voluptas voluptatem impedit!</p>
        
    <!-- <div style="width:640px;height:480px;max-width:100%">
        <div id="game"></div>
    </div> -->
    <script type="text/javascript">
        var isLoggedIn = true;
    var saveLocation = '';

    var loadState = null;

    var stringToUintArray = function( str ) {
        var buf = new Int32Array( str.length );
        for ( var i=0, strLen = str.length; i<strLen; i++ ) {
            buf[i] = str.charCodeAt(i) | 0;
        }
        return buf;
    };
    var uintArrayToString = function( uintArray ) {
        if ( !( uintArray instanceof Int32Array ) ) {
            throw new Error( 'uintArrayToString: Only accepts Int32Array parameter' );
        }
        var str = '';
        for ( var i=0, strLen = uintArray.length; i<strLen; i++ ) {
            var saveValue = uintArray[i];
            if ( saveValue > 0xFFFF ) {
                throw new Error( "Invalid value attempted to be serialised" );
            }
            str += String.fromCharCode( saveValue );
        }
        return str;
    };
    $(document.body).on('keydown', function(e) {
        if (e.keyCode >= 38 && e.keyCode <= 40) {
            e.stopPropagation();
            return false;
        }
    });
    $(function() {
        $(document).foundation();
        window.loginModal = $('#loginModal');
        window.loadModal = $('#loadStates');
        window.dialogModal = $('#dialogModal');
        $('.fb-login').click(function() {
            if (!FB) return false;
            var form = $(this).closest('.login-form');
            if (form.length) {
                form.loading();
            }

            FB.login(function(response) {
                if (form.length) {
                    form.loading('stop');
                }
                if (loginModal.is(':visible')) {
                    loginModal.loading();
                }
                if (response['status'] == 'connected') {
                    $.post('/ajax/oauth-login?from=facebook', {'access_token':response['authResponse']['accessToken']}, function(ret) {
                        if (loginModal.is(':visible')) {
                            loginModal.foundation('close');
                            loginModal.loading('stop');
                        }
                        if (ret.status == 1) {
                            $('.top-button').html(ret.menu);
                            loginModal.foundation('close');
                            // if (typeof Game != 'undefined') Game.isLoggedIn = true;
                            $(window).trigger('user.loginSuccess');
                            isLoggedIn = true;
                        } else {
                            $.toast({
                                text: 'Failed',
                                beforeShow: function () {
                                    if ($('.ejs--7a5f920ceffb2913f6dbda780573cf').length) {
                                        $('.jq-toast-wrap').appendTo($('.ejs--7a5f920ceffb2913f6dbda780573cf'));
                                    }
                                }
                            });
                        }
                    }, 'json');
                }
            }, {scope: 'public_profile,email', 'auth_type':'rerequest'});
        });

        $('.login-form [type=submit]').click(function() {
            var form = $(this).closest('.login-form');
            var username = form.find('[name=_username]').val();
            var password = form.find('[name=_password]').val();
            var remember_me = form.find('[name=_remember_me]').val();
            if (loginModal.is(':visible')) {
                loginModal.loading();
            } else {
                form.loading();
            }
            $.post('/ajax/login', {"_username":username, "_password":password, "_remember_me":remember_me}, function(ret) {
                if (loginModal.is(':visible')) {
                    loginModal.loading('stop');
                } else {
                    form.loading('stop');
                }
                if (ret.status == 1) {
                    $('.top-button').html(ret.menu);
                    loginModal.foundation('close');
                    // if (typeof Game != 'undefined') Game.isLoggedIn = true;

                    $(window).trigger('user.loginSuccess');
                    isLoggedIn = true;
                } else if (ret.error) {
                    $.toast({
                        text: ret.error,
                        beforeShow: function () {
                            if ($('.ejs--7a5f920ceffb2913f6dbda780573cf').length) {
                                $('.jq-toast-wrap').appendTo($('.ejs--7a5f920ceffb2913f6dbda780573cf'));
                            }
                        }
                    });
                }
            }, 'json');
            return false;
        });

        loadModal.on('closed.zf.reveal', function() {
            loadModal.loading('stop');
        });
        loadModal.on('open.zf.reveal', function() {
            $(window).trigger('resize');
            loadModal.find('ul.tabs a.active').trigger('click');
        });

        loadModal.on('click', '.state-item img', function() {
            var id = $(this).data('id');
            var url = $(this).data('url');
            
            loadModal.loading();
            if (url) {
                downloadState(id, url, function() {
                    loadModal.loading('stop');
                    loadModal.foundation('close');
                });
            } else {
                $.ajax({
                    type: 'POST',
                    url: '/ajax/get-state',
                    data: {
                        id: id
                    },
                    success: function(ret) {
                        var url = ret['url'];
                        downloadState(id, url, function() {
                            loadModal.loading('stop');
                            loadModal.foundation('close');
                        });
                    },
                    complete: function() {
                    }
                });
            }
        });
        loadModal.on('click', '.del', function() {
            var id = $(this).data('id');
            var self = $(this);

            confirm("Are you sure?","", function() {
            
                $.post('/ajax/del-state', {'id':id}, function(ret) {
                    self.closest('.state-item').remove();
                });

            });
            // if (window.confirm('Delete?')) {

            // }
        });

        loadModal.on('loading.start', function() {
            if ($('.ejs--7a5f920ceffb2913f6dbda780573cf').length) {
                $('.loading-overlay').appendTo($('.ejs--7a5f920ceffb2913f6dbda780573cf'));
            }
        });
        
        loadModal.on('click', 'ul.tabs li', function() {
            var index = loadModal.find(' ul.tabs li').index(this);
            
            loadModal.find('.tabs li a').removeClass('active');
            loadModal.find('.tabs li:eq('+index+') a').addClass('active');
            loadModal.find('.tab-contents .content').removeClass('active');
            loadModal.find('.tab-contents .content:eq('+index+')').addClass('active');
            if (index == 1) {
                getStatesFromServer();
            }

            return false;
        });

        
        


        var downloadState = function(id, url, func) {
            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.addEventListener("progress", function(evt) {
                        if (evt.loaded > 0) {
                            var percentComplete = evt.loaded / evt.total;
                            if (loadModal.is(':loading')) {
                                $('#loadStates_loading-overlay .loading-overlay-content').html('Loading...<br />' + (percentComplete * 100).toFixed(2) + '%');
                            }
                        }
                    }, false);
                    return xhr;
                },
                type: 'GET',
                url: url,
                data: {},
                xhrFields : {
                    responseType: 'arraybuffer'
                },
                complete: function(jqXHR) {
                    func();
                },
                success: function(data) {
                    var state = new Uint8Array(data);
                    // zlib
                    if (state[0] == 0x78) {
                        if ((state[1] == 0x01 || state[1] == 0x5E || state[1] == 0x9c || state[1] == 0xDA)) {
                            loadState(jz.zlib.decompress(state));
                        } else {
                            // Old version state
                            var f = new Blob([state], {type:"application/octet-stream"});
                            var fr = new FileReader();
                            fr.onload = function() {
                                var data = new Uint8Array(stringToUintArray(fr.result));
                                if (data[0] == 0x78 && (data[1] == 0x01 || data[1] == 0x5E || data[1] == 0x9c || data[1] == 0xDA)) {
                                    var decomressData = jz.zlib.decompress(data);
                                    loadState(decomressData);
                                } else {
                                    loadState(state);
                                }
                            };
                            fr.readAsText(f);
                        }
                    } else {
                        loadState(state);
                    }
                    // loadState(new Uint8Array(data));
                    $('#loadStates_loading-overlay .loading-overlay-content').html('Loading...');
                    func();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        };

        var stateloadField;
        var stateloadFieldChange = function(event) {
            var files = event.target.files;
            var filereader;
            if (files.length > 0) {
                filereader = new FileReader();
                filereader.file_name = files[0].name;
                filereader.onload = function() {
                    var state = new Uint8Array(filereader.result);
                    
                    // zlib
                    if (state[0] == 0x78) {
                        if ((state[1] == 0x01 || state[1] == 0x5E || state[1] == 0x9c || state[1] == 0xDA)) {
                            loadState(jz.zlib.decompress(state));
                        } else {
                            // Old version state
                            var f = new Blob([state], {type:"application/octet-stream"});
                            var fr = new FileReader()
                            fr.onload = function() {
                                var data = new Uint8Array(stringToUintArray(fr.result));
                                if (data[0] == 0x78 && (data[1] == 0x01 || data[1] == 0x5E || data[1] == 0x9c || data[1] == 0xDA)) {
                                    var decomressData = jz.zlib.decompress(data);
                                    loadState(decomressData);
                                } else {
                                    loadState(state);
                                }
                            }
                            fr.readAsText(f);
                        }
                    } else {
                        loadState(state);
                    }
        
                };
                filereader.readAsArrayBuffer(files[0]);
            }
            stateloadField = document.createElement('input');
            stateloadField.type = 'file';
            stateloadField.onchange = stateloadFieldChange;
        };
        stateloadField = document.createElement('input');
        stateloadField.type = 'file';
        stateloadField.onchange = stateloadFieldChange;

        $('#file-browse-button').click(function() {
            stateloadField.click();
            return false;
        });

        $('.drag-drop-inside').on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }).on('dragover dragenter', function() {
            $('.drag-drop-inside').addClass('is-dragover');
        })
        .on('dragleave dragend drop', function() {
            $('.drag-drop-inside').removeClass('is-dragover');
        })
        .on('drop', function(e) {
            var files = e.originalEvent.dataTransfer.files;
            filereader = new FileReader();
            filereader.file_name = files[0].name;
            filereader.onload = function() {
                var state = new Uint8Array(filereader.result);
                // zlib
                if (state[0] == 0x78) {
                    if ((state[1] == 0x01 || state[1] == 0x5E || state[1] == 0x9c || state[1] == 0xDA)) {
                        loadState(jz.zlib.decompress(state));
                    } else {
                        // Old version state
                        var f = new Blob([state], {type:"application/octet-stream"});
                        var fr = new FileReader()
                        fr.onload = function() {
                            var data = new Uint8Array(stringToUintArray(fr.result));
                            if (data[0] == 0x78 && (data[1] == 0x01 || data[1] == 0x5E || data[1] == 0x9c || data[1] == 0xDA)) {
                                var decomressData = jz.zlib.decompress(data);
                                loadState(decomressData);
                            } else {
                                loadState(state);
                            }
                        }
                        fr.readAsText(f);
                    }
                } else {
                    loadState(state);
                }
            };
            filereader.readAsArrayBuffer(files[0]);
        });

    });

        
        EJS_player = '#game';
        EJS_biosUrl = '';
        EJS_pathtodata = "https://rawcdn.githack.com/tlqhrm/nds/29002b2/";
        EJS_gameUrl = 'https://rawcdn.githack.com/tlqhrm/nds/2287297389cbfdcfcfeffdd723621d16f01e461a/%ED%8F%AC%EC%BC%93%20%EB%AA%AC%EC%8A%A4%ED%84%B0%20%EB%A3%A8%EB%B9%84(K).gba'; // Url to Game rom
        EJS_core = 'gba';

        var saveStateToLocal = function(screenshot, state) {
            saveAs(new Blob([state], {type:"application/octet-stream"}), 'game.state');
        };
        EJS_onSaveState = function(data) {

            // var state = jz.zlib.compress(new Uint8Array(fr.result));
            var state = data.state;
            var screenshot = data.screenshot;
            // saveStateToLocal(screenshot, state);
            // var f = new Blob([data.state], {type:"application/octet-stream"});
            // var fr = new FileReader();
            // fr.onload = function() {
            //     var state = jz.zlib.compress(new Uint8Array(fr.result));
            //     var screenshot = data.screenshot;
            //     saveStateToLocal(screenshot, state);
            // }
            dialogModal.foundation('open');
                dialogModal.find('h1.title').text('세이브 파일');
                dialogModal.find('.content').html(

                    '<p><input id="state_saveto_file" checked type="radio" value="file" name="saveto" /><label class="customLabel" for="state_saveto_file"><span>파일로 저장</span></label></p>'+
                    (state.length < 2.5*1024*1024 ? '<p><input id="state_saveto_server" type="radio" value="server" name="saveto" /><label class="customLabel" for="state_saveto_server"><span>서버에 저장</span></label></p>' : '') +
                    '<p><input type="checkbox" id="check_remember_saveto" name="remember_saveto" value="1" /><label for="check_remember_saveto" class="customLabel">다시 묻지 않음</label></p>');
                dialogModal.find('.actions .submit').one('click', function() {
                    var saveto = dialogModal.find('[name=saveto]:checked').val();
                    var remember = dialogModal.find('[name=remember_saveto]:checked').val();
                    if (remember == 1) {
                        // localStorage.setItem('save_location', saveto);
                        saveLocation = saveto;
                    }
                    if (saveto == 'file') {
                        saveStateToLocal(screenshot, state);
                        saving = false;
                    } else if (saveto == 'server') {
                        saveStateToServer(screenshot, state);

                    }
                });

                dialogModal.on('closed.zf.reveal', function() {
                    saving = false;
                    dialogModal.find('.actions .submit').off('click');
                });
            
            
        };
        EJS_onLoadState = function(loadStateFn) {
            loadModal.foundation('open');  
        };
    </script>
     <!-- <script src="https://rawcdn.githack.com/ethanaobrien/emulatorjs/main/data/loader.js"></script> -->
     <!-- <script src="//www.emulatorjs.com/loader.js" crossorigin></script> -->
    <script src="https://rawcdn.githack.com/tlqhrm/nds/8597767eec71a4e0fa73e3c96be48e78ca29a624/loader.js"></script>

    
</body>
</html>